name: Check yt-dlp Version and Auto-Release

on:
  schedule:
    # Run every Sunday at 00:00 UTC
    - cron: '0 0 * * 0'
  workflow_dispatch: # Allow manual triggering

permissions:
  contents: write
  actions: write

jobs:
  check-and-release:
    name: Check yt-dlp version and create release if newer
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install GitHub CLI
        run: |
          type -p curl >/dev/null || (sudo apt update && sudo apt install curl -y)
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg \
          && sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg \
          && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
          && sudo apt update \
          && sudo apt install gh -y

      - name: Get stored yt-dlp version from repository variables
        id: stored_version
        run: |
          # Get the stored version from repository variables
          # This variable should be set in: Settings -> Secrets and variables -> Actions -> Variables
          STORED_VERSION="${{ vars.YTDLP_VERSION }}"
          
          if [ -z "$STORED_VERSION" ]; then
            echo "ERROR: Repository variable YTDLP_VERSION is not set." >&2
            echo "Please set it in: Settings -> Secrets and variables -> Actions -> Variables" >&2
            exit 1
          fi
          
          echo "Stored yt-dlp version: $STORED_VERSION"
          echo "stored_version=$STORED_VERSION" >> $GITHUB_OUTPUT

      - name: Get latest yt-dlp release
        id: latest_ytdlp
        run: |
          # Install jq if not available
          if ! command -v jq &> /dev/null; then
            sudo apt-get update && sudo apt-get install -y jq
          fi
          
          # Get the latest release from yt-dlp/yt-dlp
          LATEST_RELEASE=$(curl -s https://api.github.com/repos/yt-dlp/yt-dlp/releases/latest | jq -r '.tag_name')
          
          # Remove 'v' prefix if present (e.g., v2024.1.1 -> 2024.1.1)
          LATEST_RELEASE=${LATEST_RELEASE#v}
          
          echo "Latest yt-dlp release: $LATEST_RELEASE"
          echo "latest_version=$LATEST_RELEASE" >> $GITHUB_OUTPUT

      - name: Compare versions
        id: compare
        run: |
          STORED="${{ steps.stored_version.outputs.stored_version }}"
          LATEST="${{ steps.latest_ytdlp.outputs.latest_version }}"
          
          echo "Comparing versions: stored=$STORED, latest=$LATEST"
          
          # Function to compare semantic versions
          # Returns 0 if versions are equal, 1 if stored < latest, 2 if stored > latest
          compare_versions() {
            local v1=$1
            local v2=$2
            local result=0
            
            # Split versions into arrays
            IFS='.' read -ra V1 <<< "$v1" || true
            IFS='.' read -ra V2 <<< "$v2" || true
            
            # Compare each component
            local max_len=${#V1[@]}
            if [ ${#V2[@]} -gt $max_len ]; then
              max_len=${#V2[@]}
            fi
            
            for ((i=0; i<max_len; i++)); do
              local val1=${V1[$i]:-0}
              local val2=${V2[$i]:-0}
              
              if [ "$val1" -lt "$val2" ] 2>/dev/null; then
                return 1
              elif [ "$val1" -gt "$val2" ] 2>/dev/null; then
                return 2
              fi
            done
            
            return 0
          }
          
          # Call function and capture result, handling errors
          set +e
          compare_versions "$STORED" "$LATEST"
          COMPARE_RESULT=$?
          set -e
          
          echo "Comparison result: $COMPARE_RESULT"
          
          if [ "$COMPARE_RESULT" -eq 1 ]; then
            echo "New version available: $LATEST (stored: $STORED)"
            echo "is_newer=true" >> $GITHUB_OUTPUT
          elif [ "$COMPARE_RESULT" -eq 0 ]; then
            echo "Versions are the same: $STORED"
            echo "is_newer=false" >> $GITHUB_OUTPUT
          else
            echo "Stored version is newer than latest (unexpected): $STORED > $LATEST"
            echo "is_newer=false" >> $GITHUB_OUTPUT
          fi

      - name: Get current repository version
        id: current_repo_version
        if: steps.compare.outputs.is_newer == 'true'
        run: |
          # Get the latest tag from the repository
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "0.0.0")
          
          # Remove 'v' prefix if present
          LATEST_TAG=${LATEST_TAG#v}
          
          echo "Current repository version: $LATEST_TAG"
          echo "current_version=$LATEST_TAG" >> $GITHUB_OUTPUT

      - name: Bump patch version
        id: bump_version
        if: steps.compare.outputs.is_newer == 'true'
        run: |
          CURRENT="${{ steps.current_repo_version.outputs.current_version }}"
          
          # Split version into components
          IFS='.' read -ra VERSION <<< "$CURRENT"
          MAJOR=${VERSION[0]:-0}
          MINOR=${VERSION[1]:-0}
          PATCH=${VERSION[2]:-0}
          
          # Bump patch version
          NEW_PATCH=$((PATCH + 1))
          NEW_VERSION="$MAJOR.$MINOR.$NEW_PATCH"
          
          echo "Bumping version: $CURRENT -> $NEW_VERSION"
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Create new release
        if: steps.compare.outputs.is_newer == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          NEW_VERSION="${{ steps.bump_version.outputs.new_version }}"
          YTDLP_VERSION="${{ steps.latest_ytdlp.outputs.latest_version }}"
          
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Create and push tag
          git tag -a "$NEW_VERSION" -m "Release $NEW_VERSION (yt-dlp $YTDLP_VERSION)"
          git push origin "$NEW_VERSION"
          
          # Create GitHub release
          gh release create "$NEW_VERSION" \
            --title "Release $NEW_VERSION" \
            --notes "Automated release triggered by yt-dlp update to version $YTDLP_VERSION" \
            --target master

      - name: Trigger Release workflow
        if: steps.compare.outputs.is_newer == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          NEW_VERSION="${{ steps.bump_version.outputs.new_version }}"
          echo "Triggering Release workflow for tag $NEW_VERSION"
          gh api \
            -X POST \
            repos/${{ github.repository }}/actions/workflows/release.yml/dispatches \
            -f ref=master \
            -f inputs[tag]="$NEW_VERSION"

      - name: Update stored yt-dlp version
        if: steps.compare.outputs.is_newer == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # Optional: If you want automatic variable updates, create a PAT with admin:repo scope
          # and store it as a secret named GH_PAT. Otherwise, update YTDLP_VERSION manually.
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          NEW_YTDLP_VERSION="${{ steps.latest_ytdlp.outputs.latest_version }}"
          
          # Use PAT if available, otherwise use GITHUB_TOKEN
          AUTH_TOKEN="${GH_PAT:-$GITHUB_TOKEN}"
          
          # Try to update the repository variable
          # Note: Updating repository variables requires admin permissions.
          # GITHUB_TOKEN typically doesn't have this permission, so a PAT may be needed.
          if gh api \
            -X PATCH \
            repos/${{ github.repository }}/actions/variables/YTDLP_VERSION \
            -f value="$NEW_YTDLP_VERSION" \
            --header "Authorization: token $AUTH_TOKEN" 2>/dev/null; then
            echo "✅ Successfully updated YTDLP_VERSION to $NEW_YTDLP_VERSION"
          else
            echo "⚠️ Warning: Could not update YTDLP_VERSION variable automatically." >&2
            echo "" >&2
            echo "This is expected if GITHUB_TOKEN doesn't have admin permissions." >&2
            echo "To enable automatic updates, create a Personal Access Token (PAT) with 'admin:repo' scope" >&2
            echo "and store it as a secret named 'GH_PAT' in your repository settings." >&2
            echo "" >&2
            echo "Otherwise, please update it manually:" >&2
            echo "  Settings -> Secrets and variables -> Actions -> Variables" >&2
            echo "  Set YTDLP_VERSION to: $NEW_YTDLP_VERSION" >&2
          fi

      - name: Summary
        if: always()
        run: |
          if [ "${{ steps.compare.outputs.is_newer }}" == "true" ]; then
            echo "## ✅ New Release Created" >> $GITHUB_STEP_SUMMARY
            echo "- New version: ${{ steps.bump_version.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
            echo "- yt-dlp version: ${{ steps.latest_ytdlp.outputs.latest_version }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "## ℹ️ No Update Needed" >> $GITHUB_STEP_SUMMARY
            echo "- Current yt-dlp version: ${{ steps.stored_version.outputs.stored_version }}" >> $GITHUB_STEP_SUMMARY
            echo "- Latest yt-dlp version: ${{ steps.latest_ytdlp.outputs.latest_version }}" >> $GITHUB_STEP_SUMMARY
          fi

